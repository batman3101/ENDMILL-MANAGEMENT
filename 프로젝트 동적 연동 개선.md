# 프로젝트 동적 연동 개선 계획

## 📌 개요

현재 시스템은 CAM Sheet 기반의 정적 정보만 표시하고 있으며, 설비의 실시간 생산 상태와 앤드밀 정보가 연동되지 않는 문제가 있습니다. 본 문서는 PRD에 명시된 "모든 모듈이 서로 긴밀한 관계성을 가져야 한다"는 요구사항을 충족하기 위한 수정 계획입니다.

---

## 🔍 1단계: 현재 문제 분석

### 현재 데이터 구조의 문제점

```
❌ 현재 (분리된 구조):

CAM Sheet 영역 (정적)          설비 영역 (동적)
┌─────────────────┐           ┌─────────────────┐
│ cam_sheets      │           │ equipment       │
│ - model         │           │ - current_model │
│ - process       │           │ - process       │
└────────┬────────┘           └────────┬────────┘
         │                             │
         ▼                             ▼
┌─────────────────┐           ┌─────────────────┐
│cam_sheet_endmills│          │ tool_positions  │
│ - endmill_code  │           │ - endmill_type_id│
│ - tool_life     │           │ - current_life  │
└─────────────────┘           └─────────────────┘

앤드밀 상세 페이지는 왼쪽만 조회 → 실시간 정보 없음
```

### 구체적 문제 시나리오

**상황:**
- 설비 C001이 어제까지 PA1+CNC1 생산
- 오늘 R13+CNC2로 변경
- AL002 앤드밀이 C001에 장착됨

**현재 동작:**
- equipment 테이블만 업데이트: `current_model=R13, process=CNC2`
- cam_sheet_endmills 테이블은 변경 없음
- 앤드밀 상세 페이지는 CAM Sheet 정보만 보여줌 (PA1+CNC1, R13+CNC2 둘 다 표시)
- 실제 C001이 R13+CNC2로 변경된 사실이 반영되지 않음

---

## 🎯 2단계: 목표 아키텍처 설계

### 필요한 데이터 관계

```
✅ 목표 (통합된 구조):

                앤드밀 타입
                ┌─────────────┐
                │endmill_types│
                └──────┬──────┘
                       │
        ┌──────────────┼──────────────┐
        ▼              ▼              ▼
   ┌─────────┐  ┌──────────┐  ┌──────────┐
   │CAM Sheet│  │설비 장착  │  │재고      │
   │매핑     │  │상태      │  │         │
   └─────────┘  └──────────┘  └──────────┘
   (사양 정보)  (실시간 위치) (수량 정보)
```

### 통합 후 정보 흐름

1. **앤드밀 → 설비 조회**: 어떤 설비에서 현재 사용 중인지
2. **설비 → 앤드밀 조회**: 현재 장착된 앤드밀 목록
3. **CAM Sheet 사양 연동**: 설비의 모델/공정에 맞는 사양 자동 적용
4. **실시간 수명 추적**: 설비별 앤드밀 사용 현황

---

## 📋 3단계: 수정이 필요한 컴포넌트 파악

### 영향받는 페이지/API

#### 1. 앤드밀 관리 페이지
- ✅ 현재: CAM Sheet 매핑 정보만 표시
- 🔧 추가: 현재 사용중인 설비 표시
- 🔧 추가: 설비별 Tool Life 실시간 표시

#### 2. 설비 관리 페이지
- ✅ 현재: 설비 기본 정보만 표시
- 🔧 추가: 현재 모델/공정에 맞는 CAM Sheet 자동 연결
- 🔧 추가: 장착된 앤드밀 실시간 표시

#### 3. 공구 교체 페이지
- ✅ 현재: tool_changes 테이블만 기록
- 🔧 추가: tool_positions 업데이트
- 🔧 추가: 설비 모델/공정 변경 시 CAM Sheet 자동 전환

#### 4. 대시보드
- ✅ 현재: 재고 기반 통계만 표시
- 🔧 추가: 앤드밀별 실제 사용 설비 개수
- 🔧 추가: 모델별 앤드밀 사용 현황

---

## 🛠️ 4단계: 데이터베이스 수정 계획

### Option 1: tool_positions 테이블 활용 (권장)

현재 `tool_positions` 테이블 구조:
```sql
tool_positions:
  - id (PK)
  - equipment_id (FK → equipment)
  - position_number (T01~T24)
  - endmill_type_id (FK → endmill_types)
  - current_life (현재 수명)
  - total_life (총 수명)
  - install_date (설치일)
  - status (상태: active/inactive)
  - created_at
  - updated_at
```

**장점:**
- 이미 모든 필요한 정보가 있음
- equipment와 JOIN하면 current_model, process 확인 가능
- 추가 테이블 불필요

**필요한 쿼리 패턴:**
```sql
-- 앤드밀 상세 페이지: 이 앤드밀을 사용중인 설비 조회
SELECT
  e.equipment_number,
  e.current_model,
  e.process,
  tp.position_number,
  tp.current_life,
  tp.total_life,
  tp.install_date,
  cs.tool_life as spec_tool_life
FROM tool_positions tp
JOIN equipment e ON tp.equipment_id = e.id
LEFT JOIN cam_sheets cs ON cs.model = e.current_model
  AND cs.process = e.process
LEFT JOIN cam_sheet_endmills cse ON cse.cam_sheet_id = cs.id
  AND cse.endmill_type_id = tp.endmill_type_id
WHERE tp.endmill_type_id = 'AL002_ID'
  AND tp.status = 'active'
```

---

## 🔄 5단계: API 수정 순서

### Phase 1: API 확장 (기존 기능 유지)

#### API 수정: `app/api/endmill/route.ts`

**현재 응답:**
```json
{
  "code": "AL002",
  "camSheets": [
    {
      "model": "PA1",
      "process": "CNC1",
      "toolLife": 500,
      "tNumber": 12
    }
  ],
  "inventory": {...}
}
```

**수정 후 응답:**
```json
{
  "code": "AL002",
  "camSheets": [
    {
      "model": "PA1",
      "process": "CNC1",
      "toolLife": 500,
      "tNumber": 12
    }
  ],
  "currentUsage": [
    {
      "equipmentNumber": "C001",
      "equipmentModel": "R13",
      "equipmentProcess": "CNC2",
      "positionNumber": 15,
      "currentLife": 450,
      "totalLife": 600,
      "installDate": "2025-10-01",
      "status": "active",
      "specToolLife": 600,
      "usagePercentage": 75
    }
  ],
  "inventory": {...}
}
```

---

## 📝 6단계: 구체적 수정 과정

### Step 1: API 레이어 수정

#### 파일: `app/api/endmill/route.ts`

```typescript
export async function GET(request: NextRequest) {
  try {
    const supabase = createServerClient()
    const url = new URL(request.url)
    const code = url.searchParams.get('code')

    if (code) {
      const result = await supabase
        .from('endmill_types')
        .select(`
          *,
          endmill_categories(code, name_ko),
          endmill_supplier_prices(
            unit_price,
            suppliers(code, name)
          ),
          cam_sheet_endmills(
            tool_life,
            t_number,
            cam_sheets(model, process)
          ),
          tool_positions(              // ← 추가!
            position_number,
            current_life,
            total_life,
            install_date,
            status,
            equipment:equipment_id(    // ← JOIN
              equipment_number,
              current_model,
              process
            )
          ),
          inventory(
            current_stock,
            min_stock,
            max_stock,
            status,
            location
          )
        `)
        .eq('code', code.toUpperCase())
        .single()

      endmillTypes = result.data
      error = result.error
    }

    // 데이터 가공
    const processEndmill = (endmill: any) => {
      // CAM Sheet 정보 (기존)
      const camSheets = endmill.cam_sheet_endmills?.map((cs: any) => ({
        model: cs.cam_sheets?.model || '',
        process: cs.cam_sheets?.process || '',
        toolLife: cs.tool_life,
        tNumber: cs.t_number
      })) || []

      // 실시간 사용 현황 (신규) ← 추가!
      const currentUsage = endmill.tool_positions
        ?.filter((tp: any) => tp.status === 'active')
        ?.map((tp: any) => {
          // 현재 설비의 모델/공정에 맞는 CAM Sheet 사양 찾기
          const matchingCamSheet = endmill.cam_sheet_endmills?.find(
            (cs: any) =>
              cs.cam_sheets?.model === tp.equipment?.current_model &&
              cs.cam_sheets?.process === tp.equipment?.process
          )

          return {
            equipmentNumber: tp.equipment?.equipment_number,
            equipmentModel: tp.equipment?.current_model,
            equipmentProcess: tp.equipment?.process,
            positionNumber: tp.position_number,
            currentLife: tp.current_life,
            totalLife: tp.total_life,
            installDate: tp.install_date,
            status: tp.status,
            specToolLife: matchingCamSheet?.tool_life || null,
            usagePercentage: tp.total_life > 0
              ? Math.round((tp.current_life / tp.total_life) * 100)
              : 0
          }
        }) || []

      return {
        id: endmill.id,
        code: endmill.code,
        category: endmill.endmill_categories?.code || '',
        categoryName: endmill.endmill_categories?.name_ko || '',
        name: endmill.name,
        unitCost: endmill.unit_cost,
        standardLife: endmill.standard_life,
        suppliers: endmill.endmill_supplier_prices?.map((sp: any) => ({
          code: sp.suppliers?.code || '',
          name: sp.suppliers?.name || '',
          unitPrice: sp.unit_price
        })) || [],
        camSheets,           // CAM Sheet 사양 정보 (정적)
        currentUsage,        // 실시간 사용 현황 (동적) ← 추가!
        inventory: endmill.inventory ? {
          currentStock: endmill.inventory.current_stock,
          minStock: endmill.inventory.min_stock,
          maxStock: endmill.inventory.max_stock,
          status: endmill.inventory.status,
          location: endmill.inventory.location
        } : null,
        createdAt: endmill.created_at,
        updatedAt: endmill.updated_at
      }
    }

    const processedEndmills = code
      ? (endmillTypes ? [processEndmill(endmillTypes as any)] : [])
      : (Array.isArray(endmillTypes) ? endmillTypes.map(processEndmill) : [])

    return NextResponse.json({
      success: true,
      data: processedEndmills,
      count: processedEndmills.length
    })

  } catch (error) {
    logger.error('엔드밀 조회 API 오류:', error)
    return NextResponse.json(
      { error: error instanceof Error ? error.message : '서버 오류가 발생했습니다.' },
      { status: 500 }
    )
  }
}
```

---

### Step 2: 타입 정의 추가

#### 파일: `lib/types/endmill.ts`

```typescript
// 기존 타입에 추가
export interface EndmillCurrentUsage {
  equipmentNumber: string
  equipmentModel: string
  equipmentProcess: string
  positionNumber: number
  currentLife: number
  totalLife: number
  installDate: string
  status: string
  specToolLife: number | null
  usagePercentage: number
}

export interface EndmillDetailInfo extends EndmillMaster {
  // 기존 필드들...

  // CAM Sheet 사양 정보 (정적)
  camSheets: Array<{
    model: string
    process: string
    toolLife: number
    tNumber: number
  }>

  // 실시간 사용 현황 (동적) ← 추가!
  currentUsage: EndmillCurrentUsage[]

  // 기타 필드들...
}
```

---

### Step 3: 프론트엔드 수정

#### 파일: `app/dashboard/endmill-detail/[code]/page.tsx`

```typescript
'use client'

import { useParams, useRouter } from 'next/navigation'
import { useState, useEffect } from 'react'
import { EndmillDetailInfo } from '../../../../lib/types/endmill'

export default function EndmillDetailPage() {
  const params = useParams()
  const endmillCode = params.code as string
  const [endmillData, setEndmillData] = useState<EndmillDetailInfo | null>(null)
  const [loading, setLoading] = useState(true)

  useEffect(() => {
    const fetchEndmillData = async () => {
      try {
        const response = await fetch(`/api/endmill?code=${endmillCode}`)
        const result = await response.json()

        if (result.success && result.data.length > 0) {
          setEndmillData(result.data[0])
        }
      } catch (error) {
        console.error('데이터 로딩 오류:', error)
      } finally {
        setLoading(false)
      }
    }

    fetchEndmillData()
  }, [endmillCode])

  if (loading) return <div>로딩중...</div>
  if (!endmillData) return <div>앤드밀을 찾을 수 없습니다</div>

  return (
    <div className="min-h-screen bg-gray-50 p-6">
      <h1 className="text-2xl font-bold mb-6">
        {endmillData.code} - {endmillData.name}
      </h1>

      {/* 실시간 사용 현황 섹션 (신규) */}
      <section className="bg-white rounded-lg shadow p-6 mb-6">
        <h2 className="text-xl font-semibold mb-4">
          📊 실시간 사용 현황 ({endmillData.currentUsage.length}개 설비)
        </h2>

        {endmillData.currentUsage.length > 0 ? (
          <div className="overflow-x-auto">
            <table className="min-w-full divide-y divide-gray-200">
              <thead className="bg-gray-50">
                <tr>
                  <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">
                    설비번호
                  </th>
                  <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">
                    모델
                  </th>
                  <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">
                    공정
                  </th>
                  <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">
                    T번호
                  </th>
                  <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">
                    현재 수명
                  </th>
                  <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">
                    총 수명
                  </th>
                  <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">
                    사양 수명
                  </th>
                  <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">
                    사용률
                  </th>
                  <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">
                    설치일
                  </th>
                </tr>
              </thead>
              <tbody className="bg-white divide-y divide-gray-200">
                {endmillData.currentUsage.map((usage, index) => (
                  <tr key={index} className="hover:bg-gray-50">
                    <td className="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">
                      {usage.equipmentNumber}
                    </td>
                    <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                      {usage.equipmentModel}
                    </td>
                    <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                      {usage.equipmentProcess}
                    </td>
                    <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                      T{usage.positionNumber.toString().padStart(2, '0')}
                    </td>
                    <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                      {usage.currentLife}회
                    </td>
                    <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                      {usage.totalLife}회
                    </td>
                    <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                      {usage.specToolLife ? `${usage.specToolLife}회` : 'N/A'}
                    </td>
                    <td className="px-6 py-4 whitespace-nowrap">
                      <div className="flex items-center">
                        <span className={`text-sm font-medium ${
                          usage.usagePercentage > 80 ? 'text-red-600' :
                          usage.usagePercentage > 50 ? 'text-yellow-600' :
                          'text-green-600'
                        }`}>
                          {usage.usagePercentage}%
                        </span>
                        <div className="ml-2 w-24 bg-gray-200 rounded-full h-2">
                          <div
                            className={`h-2 rounded-full ${
                              usage.usagePercentage > 80 ? 'bg-red-600' :
                              usage.usagePercentage > 50 ? 'bg-yellow-600' :
                              'bg-green-600'
                            }`}
                            style={{ width: `${usage.usagePercentage}%` }}
                          />
                        </div>
                      </div>
                    </td>
                    <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                      {new Date(usage.installDate).toLocaleDateString('ko-KR')}
                    </td>
                  </tr>
                ))}
              </tbody>
            </table>
          </div>
        ) : (
          <div className="text-center py-8 text-gray-500">
            현재 사용중인 설비가 없습니다.
          </div>
        )}
      </section>

      {/* CAM Sheet 사양 정보 (기존) */}
      <section className="bg-white rounded-lg shadow p-6">
        <h2 className="text-xl font-semibold mb-4">
          📋 등록된 CAM Sheet 사양
        </h2>

        {endmillData.camSheets.length > 0 ? (
          <div className="overflow-x-auto">
            <table className="min-w-full divide-y divide-gray-200">
              <thead className="bg-gray-50">
                <tr>
                  <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">
                    모델
                  </th>
                  <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">
                    공정
                  </th>
                  <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">
                    T Number
                  </th>
                  <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">
                    사양 수명
                  </th>
                </tr>
              </thead>
              <tbody className="bg-white divide-y divide-gray-200">
                {endmillData.camSheets.map((sheet, index) => (
                  <tr key={index} className="hover:bg-gray-50">
                    <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                      {sheet.model}
                    </td>
                    <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                      {sheet.process}
                    </td>
                    <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                      T{sheet.tNumber.toString().padStart(2, '0')}
                    </td>
                    <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                      {sheet.toolLife}회
                    </td>
                  </tr>
                ))}
              </tbody>
            </table>
          </div>
        ) : (
          <div className="text-center py-8 text-gray-500">
            등록된 CAM Sheet 사양이 없습니다.
          </div>
        )}
      </section>
    </div>
  )
}
```

---

### Step 4: 설비 페이지 수정

#### 파일: `app/api/equipment/route.ts`

```typescript
export async function GET(request: NextRequest) {
  try {
    const supabase = createServerClient()
    const { searchParams } = new URL(request.url)
    const equipmentNumber = searchParams.get('equipmentNumber')

    if (equipmentNumber) {
      // 특정 설비 조회
      const { data: equipment, error } = await supabase
        .from('equipment')
        .select(`
          *,
          tool_positions(
            position_number,
            current_life,
            total_life,
            install_date,
            status,
            endmill_types(
              id,
              code,
              name,
              endmill_categories(code, name_ko)
            )
          )
        `)
        .eq('equipment_number', equipmentNumber)
        .single()

      if (error) throw error

      // 현재 모델/공정에 맞는 CAM Sheet 조회
      const { data: camSheet } = await supabase
        .from('cam_sheets')
        .select(`
          *,
          cam_sheet_endmills(
            t_number,
            tool_life,
            endmill_code,
            endmill_name,
            endmill_types(code, name)
          )
        `)
        .eq('model', equipment.current_model)
        .eq('process', equipment.process)
        .single()

      return NextResponse.json({
        success: true,
        data: {
          ...equipment,
          camSheet: camSheet || null
        }
      })
    }

    // 전체 설비 목록 조회는 기존과 동일
    // ...
  } catch (error) {
    logger.error('설비 조회 오류:', error)
    return NextResponse.json(
      { error: '설비 정보를 불러오는데 실패했습니다.' },
      { status: 500 }
    )
  }
}
```

---

### Step 5: 공구 교체 프로세스 수정

#### 파일: `app/api/tool-changes/route.ts`

```typescript
export async function POST(request: NextRequest) {
  try {
    const body = await request.json()
    const supabase = createServerClient()

    // 1. tool_changes 테이블에 기록 (기존)
    const { data: toolChange, error: changeError } = await supabase
      .from('tool_changes')
      .insert({
        equipment_id: body.equipment_id,
        position_number: body.position_number,
        old_endmill_id: body.old_endmill_id,
        new_endmill_id: body.new_endmill_id,
        change_reason: body.change_reason,
        changed_by: body.changed_by,
        previous_life: body.previous_life
      })
      .select()
      .single()

    if (changeError) throw changeError

    // 2. tool_positions 업데이트 (신규 추가!)
    // 설비의 현재 모델/공정에 맞는 CAM Sheet 조회
    const { data: equipment } = await supabase
      .from('equipment')
      .select('current_model, process')
      .eq('id', body.equipment_id)
      .single()

    const { data: camSheetEndmill } = await supabase
      .from('cam_sheet_endmills')
      .select('tool_life, cam_sheets!inner(model, process)')
      .eq('endmill_type_id', body.new_endmill_id)
      .eq('cam_sheets.model', equipment.current_model)
      .eq('cam_sheets.process', equipment.process)
      .single()

    const specToolLife = camSheetEndmill?.tool_life || 2000 // 기본값

    const { error: positionError } = await supabase
      .from('tool_positions')
      .upsert({
        equipment_id: body.equipment_id,
        position_number: body.position_number,
        endmill_type_id: body.new_endmill_id,
        current_life: 0,
        total_life: specToolLife,
        install_date: new Date().toISOString(),
        status: 'active'
      }, {
        onConflict: 'equipment_id,position_number'
      })

    if (positionError) {
      logger.warn('tool_positions 업데이트 실패:', positionError)
    }

    // 3. 재고 감소 (기존)
    const { error: inventoryError } = await supabase
      .from('inventory')
      .update({
        current_stock: supabase.raw('current_stock - 1')
      })
      .eq('endmill_type_id', body.new_endmill_id)

    if (inventoryError) {
      logger.warn('재고 업데이트 실패:', inventoryError)
    }

    return NextResponse.json({
      success: true,
      data: toolChange,
      message: '공구 교체가 완료되었습니다.'
    })

  } catch (error) {
    logger.error('공구 교체 오류:', error)
    return NextResponse.json(
      { error: '공구 교체 중 오류가 발생했습니다.' },
      { status: 500 }
    )
  }
}
```

---

### Step 6: 설비 배정 변경 API 추가

#### 파일: `app/api/equipment/[id]/assign/route.ts` (신규)

```typescript
import { NextRequest, NextResponse } from 'next/server'
import { createServerClient } from '../../../../../lib/supabase/client'
import { logger } from '@/lib/utils/logger'

// 설비 배정 변경 (모델/공정 변경)
export async function PUT(
  request: NextRequest,
  { params }: { params: { id: string } }
) {
  try {
    const { current_model, process } = await request.json()
    const supabase = createServerClient()

    // 1. equipment 테이블 업데이트
    const { data: equipment, error: equipmentError } = await supabase
      .from('equipment')
      .update({
        current_model,
        process,
        updated_at: new Date().toISOString()
      })
      .eq('id', params.id)
      .select()
      .single()

    if (equipmentError) throw equipmentError

    // 2. tool_positions의 total_life를 새 CAM Sheet 사양에 맞게 업데이트
    const { data: toolPositions } = await supabase
      .from('tool_positions')
      .select('id, endmill_type_id, position_number')
      .eq('equipment_id', params.id)
      .eq('status', 'active')

    if (toolPositions && toolPositions.length > 0) {
      for (const position of toolPositions) {
        // 새 모델/공정에 맞는 CAM Sheet 사양 조회
        const { data: camSheetEndmill } = await supabase
          .from('cam_sheet_endmills')
          .select('tool_life, cam_sheets!inner(model, process)')
          .eq('endmill_type_id', position.endmill_type_id)
          .eq('cam_sheets.model', current_model)
          .eq('cam_sheets.process', process)
          .single()

        if (camSheetEndmill) {
          // total_life 업데이트
          await supabase
            .from('tool_positions')
            .update({
              total_life: camSheetEndmill.tool_life
            })
            .eq('id', position.id)
        }
      }
    }

    return NextResponse.json({
      success: true,
      data: equipment,
      message: '설비 배정이 변경되었습니다.'
    })

  } catch (error) {
    logger.error('설비 배정 변경 오류:', error)
    return NextResponse.json(
      { error: '설비 배정 변경 중 오류가 발생했습니다.' },
      { status: 500 }
    )
  }
}
```

---

## 📅 7단계: 구현 우선순위

### Phase 1 (고우선순위): 핵심 연결

**기간:** Week 1-2

**작업 목록:**
- [ ] tool_positions 데이터 정합성 확인
- [ ] API 수정: `/api/endmill` (currentUsage 추가)
- [ ] 타입 정의 추가: `EndmillCurrentUsage`
- [ ] 앤드밀 상세 페이지 UI 수정
- [ ] 테스트: 실시간 사용 현황 표시 확인

**목표:** 앤드밀 상세 페이지에서 실제 사용 설비 확인 가능

---

### Phase 2 (중우선순위): 양방향 연결

**기간:** Week 3-4

**작업 목록:**
- [ ] API 수정: `/api/equipment` (tool_positions 조회)
- [ ] 설비 상세 페이지 수정
- [ ] 설비 모델/공정 변경 API 생성 (`/api/equipment/[id]/assign`)
- [ ] 설비 모델/공정 변경 시 CAM Sheet 자동 매칭
- [ ] 테스트: 설비 페이지에서 장착된 앤드밀 확인

**목표:** 설비 ↔ 앤드밀 양방향 확인 가능

---

### Phase 3 (필수): 데이터 동기화

**기간:** Week 5

**작업 목록:**
- [ ] 공구 교체 API 수정 (tool_positions 업데이트)
- [ ] 설비 배정 변경 시 total_life 자동 업데이트
- [ ] 실시간 동기화 테스트
- [ ] 데이터 정합성 검증

**목표:** 모든 변경사항이 실시간 반영

---

### Phase 4 (개선): 대시보드 & 리포트

**기간:** Week 6

**작업 목록:**
- [ ] 대시보드 수정: 실시간 사용 현황 반영
- [ ] 리포트 수정: 설비별 앤드밀 사용 이력
- [ ] 성능 최적화 (800대 설비 대응)
- [ ] 전체 통합 테스트

**목표:** 모든 페이지 데이터 일관성 확보

---

## 🧪 8단계: 테스트 시나리오

### 시나리오 1: 설비 배정 변경

**Given:** 설비 C001이 PA1+CNC1 생산 중, AL002 사용 중

**When:** 설비를 R13+CNC2로 변경

**Then:**
- ✅ equipment 테이블 업데이트: `current_model=R13, process=CNC2`
- ✅ tool_positions의 total_life가 R13+CNC2 사양으로 업데이트
- ✅ 앤드밀 상세 페이지에서 C001이 R13+CNC2로 표시
- ✅ CAM Sheet의 R13+CNC2 사양이 자동 적용

---

### 시나리오 2: 공구 교체

**Given:** 설비 C001의 T15에 AL002 장착 (R13+CNC2 생산 중)

**When:** AL002를 AL005로 교체

**Then:**
- ✅ tool_changes 테이블에 교체 기록
- ✅ tool_positions 업데이트: endmill_type_id=AL005, current_life=0, total_life=R13+CNC2 사양
- ✅ inventory 테이블: AL005 재고 감소
- ✅ 앤드밀 상세(AL002)에서 C001 제거
- ✅ 앤드밀 상세(AL005)에서 C001 추가

---

### 시나리오 3: 새 CAM Sheet 추가

**Given:**
- AL002가 PA1+CNC1, R13+CNC2에만 등록
- 설비 C050이 PA1+CNC4 생산 중, AL002 사용 중

**When:** PA1+CNC4 CAM Sheet 추가 (AL002 포함, Tool Life=450)

**Then:**
- ✅ cam_sheets 테이블에 PA1+CNC4 추가
- ✅ cam_sheet_endmills 테이블에 매핑 추가
- ✅ 앤드밀 상세 페이지 "등록된 CAM Sheet 사양"에 PA1+CNC4 표시
- ✅ 앤드밀 상세 페이지 "실시간 사용 현황"에 C050이 PA1+CNC4로 표시
- ✅ C050의 tool_positions total_life가 450으로 업데이트

---

### 시나리오 4: 설비 조회

**Given:** 설비 C001에 여러 앤드밀 장착

**When:** 설비 상세 페이지 조회

**Then:**
- ✅ 현재 모델/공정 표시
- ✅ 장착된 앤드밀 목록 표시 (T01~T24)
- ✅ 각 앤드밀의 현재 수명/총 수명 표시
- ✅ 현재 모델/공정에 맞는 CAM Sheet 사양 표시

---

## 🎯 9단계: 최종 결과물

### 앤드밀 상세 페이지 최종 구조

```
┌─────────────────────────────────────────────┐
│ AL002 - BULL NOSE                           │
├─────────────────────────────────────────────┤
│                                             │
│ 📊 실시간 사용 현황 (5개 설비)              │
│ ┌───────┬─────┬─────┬────┬──────┬─────┐    │
│ │ 설비  │모델 │공정 │T번호│ 수명 │사용률│   │
│ ├───────┼─────┼─────┼────┼──────┼─────┤    │
│ │ C001  │ R13 │CNC2 │T15 │450/600│ 75% │   │
│ │ C025  │ PA1 │CNC1 │T12 │380/500│ 76% │   │
│ │ C150  │ R13 │CNC2 │T15 │200/600│ 33% │   │
│ └───────┴─────┴─────┴────┴──────┴─────┘    │
│ ← 이것이 실시간 동적 정보                    │
│                                             │
│ 📋 등록된 CAM Sheet 사양                    │
│ ┌─────┬─────┬────────────┐                 │
│ │모델 │공정 │ 사양 수명   │                 │
│ ├─────┼─────┼────────────┤                 │
│ │ PA1 │CNC1 │ 500회      │                 │
│ │ PA1 │CNC2 │ 500회      │                 │
│ │ R13 │CNC1 │ 123회      │                 │
│ │ R13 │CNC2 │ 600회      │                 │
│ └─────┴─────┴────────────┘                 │
│ ← 이것이 CAM Sheet 정적 정보                │
└─────────────────────────────────────────────┘
```

---

### 설비 상세 페이지 최종 구조

```
┌─────────────────────────────────────────────┐
│ 설비 C001                                   │
│ 현재 생산: R13 - CNC2                       │
├─────────────────────────────────────────────┤
│                                             │
│ 🔧 장착된 앤드밀 (21개 포지션)              │
│ ┌────┬────────┬──────┬──────┬──────┐       │
│ │T번호│앤드밀  │카테고리│ 수명 │사용률│      │
│ ├────┼────────┼──────┼──────┼──────┤       │
│ │T01 │AL005   │FLAT  │100/500│ 20% │       │
│ │T02 │AL010   │BALL  │250/400│ 63% │       │
│ │...│        │      │      │     │       │
│ │T15 │AL002   │B.NOSE│450/600│ 75% │       │
│ └────┴────────┴──────┴──────┴──────┘       │
│                                             │
│ 📋 현재 모델/공정의 CAM Sheet 사양           │
│ ┌────┬────────┬──────┐                     │
│ │T번호│앤드밀  │사양수명│                    │
│ ├────┼────────┼──────┤                     │
│ │T01 │AL005   │500회 │                     │
│ │T02 │AL010   │400회 │                     │
│ │T15 │AL002   │600회 │                     │
│ └────┴────────┴──────┘                     │
└─────────────────────────────────────────────┘
```

---

## ✅ 10단계: 최종 체크리스트

### 데이터베이스
- [ ] tool_positions에 모든 설비의 실제 장착 정보 입력
- [ ] equipment의 current_model, process 정확성 확인
- [ ] cam_sheet_endmills에 모든 모델/공정 조합 등록
- [ ] 데이터 정합성 검증 쿼리 실행

### API
- [ ] `/api/endmill` - tool_positions 조회 추가
- [ ] `/api/equipment` - tool_positions 조회 추가
- [ ] `/api/tool-changes` - tool_positions 업데이트 추가
- [ ] `/api/equipment/[id]/assign` - 설비 배정 변경 API 생성
- [ ] 모든 API 응답 타입 정의 업데이트

### 프론트엔드
- [ ] 앤드밀 상세 페이지 - 실시간 사용 현황 섹션 추가
- [ ] 설비 상세 페이지 - 장착된 앤드밀 목록 표시
- [ ] 공구 교체 페이지 - tool_positions 동기화
- [ ] 대시보드 - 실시간 데이터 반영
- [ ] 로딩 상태 및 에러 처리

### 테스트
- [ ] 설비 배정 변경 → 앤드밀 페이지 자동 반영
- [ ] 공구 교체 → 양쪽 페이지 동기화
- [ ] CAM Sheet 추가 → 사양 정보 표시
- [ ] 성능 테스트 (800대 설비 대응)
- [ ] 동시성 테스트 (여러 사용자 동시 수정)

### 문서화
- [ ] API 문서 업데이트
- [ ] 데이터 흐름도 작성
- [ ] 사용자 가이드 업데이트
- [ ] 개발자 가이드 업데이트

---

## 🚀 다음 단계

1. **Phase 1 착수**: 앤드밀 상세 페이지 실시간 사용 현황 추가
2. **데이터 검증**: tool_positions 테이블 데이터 정합성 확인
3. **점진적 배포**: Phase별로 순차적으로 배포 및 테스트
4. **사용자 피드백 수집**: 실제 사용자 테스트 및 개선

---

## 📚 참고 자료

- PRD 문서
- 데이터베이스 스키마: `lib/types/database.ts`
- 기존 API: `app/api/endmill/route.ts`
- 설비 API: `app/api/equipment/route.ts`
- 공구 교체 API: `app/api/tool-changes/route.ts`

---

**작성일:** 2025-10-10
**버전:** 1.0
**상태:** 계획 단계
